{"version":3,"file":"index.js","names":["_fs","_interopRequireDefault","require","_path","_hip412MetadataSchema","_validateObjectWithSchema","_errorToMessage","_dictionary","_mirrorNode","_uriDecoder","_validationError","_getNftMetadatasFromCollection","obj","__esModule","default","TokenMetadataValidator","validateSingleMetadataObject","object","errors","validateObjectWithSchema","Hip412MetadataSchema","validationMetadataErrorOptions","err","ValidationError","push","errorToMessage","isValid","length","validateArrayOfObjects","metadataObjects","results","allObjectsValid","forEach","metadataObject","index","e","errorMessage","errorsCount","map","error","validateLocalFile","filePath","fileContent","fs","readFileSync","JSON","parse","validateLocalDirectory","directoryPath","filesForValidation","readdirSync","filter","file","endsWith","sort","a","b","numA","parseInt","match","numB","general","dictionary","validation","directoryIsEmpty","path","join","validationResult","fileName","validateOnChainArrayOfObjects","serialNumber","message","metadata","validateMetadataFromOnChainCollection","network","tokenId","ipfsGateway","limit","arguments","undefined","getNftMetadataFromCollection","validateSingleOnChainNFTMetadata","nft","getSingleNFTDetails","decodedNFTMetadataURL","uriDecoder","getMetadataObjectsForValidation","missingAttributes","exports"],"sources":["../../../src/token-metadata-validator/index.ts"],"sourcesContent":["/*-\n *\n * Hedera NFT SDK\n *\n * Copyright (C) 2024 Hedera Hashgraph, LLC\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n *\n */\nimport fs from 'fs';\nimport path from 'path';\nimport { NetworkName } from '@hashgraph/sdk/lib/client/Client';\nimport { Hip412MetadataSchema } from '../utils/validation-schemas/hip412-metadata-schema';\nimport { validateObjectWithSchema, validationMetadataErrorOptions } from '../helpers/validate-object-with-schema';\nimport { errorToMessage } from '../helpers/error-to-message';\nimport { MetadataObject } from '../types/csv';\nimport { dictionary } from '../utils/constants/dictionary';\nimport { getMetadataObjectsForValidation, getSingleNFTDetails, MetadataFromMirrorNode } from '../api/mirror-node';\nimport { uriDecoder } from '../helpers/uri-decoder';\nimport { ValidationError } from '../utils/validation-error';\nimport { getNftMetadataFromCollection } from '../helpers/get-nft-metadatas-from-collection';\nimport { NFTMetadata } from '../types/nft-metadata';\nimport {\n  FileValidationResult,\n  DetailedFileValidationResult,\n  ValidateArrayOfObjectsResult,\n  DirectoryValidationResult,\n  MetadataError,\n} from '../types/hip412-validator';\n\nexport class TokenMetadataValidator {\n  static validateSingleMetadataObject(object: MetadataObject | NFTMetadata): FileValidationResult {\n    const errors: string[] = [];\n\n    try {\n      validateObjectWithSchema(Hip412MetadataSchema, object, validationMetadataErrorOptions);\n    } catch (err) {\n      if (err instanceof ValidationError) {\n        errors.push(...err.errors);\n      } else {\n        errors.push(errorToMessage(err));\n      }\n    }\n\n    return {\n      isValid: errors.length === 0,\n      errors,\n    };\n  }\n\n  static validateArrayOfObjects(metadataObjects: MetadataObject[]): ValidateArrayOfObjectsResult {\n    const results: { [index: number]: DetailedFileValidationResult } = {};\n    let allObjectsValid = true;\n\n    metadataObjects.forEach((metadataObject, index) => {\n      const errors: string[] = [];\n      try {\n        validateObjectWithSchema(Hip412MetadataSchema, metadataObject, validationMetadataErrorOptions);\n      } catch (e) {\n        allObjectsValid = false;\n        const errorMessage = errorToMessage(e);\n        if (e instanceof ValidationError) {\n          errors.push(...e.errors);\n        } else {\n          errors.push(errorMessage);\n        }\n      }\n      results[index] = {\n        isValid: errors.length === 0,\n        errorsCount: errors.length,\n        errors: errors.map((error) => error),\n      };\n    });\n\n    return {\n      allObjectsValid,\n      results,\n    };\n  }\n\n  static validateLocalFile(filePath: string): FileValidationResult {\n    try {\n      const fileContent = fs.readFileSync(filePath, 'utf8');\n      const object: MetadataObject = JSON.parse(fileContent);\n      return this.validateSingleMetadataObject(object);\n    } catch (error) {\n      return {\n        isValid: false,\n        errors: [errorToMessage(error)],\n      };\n    }\n  }\n\n  static validateLocalDirectory(directoryPath: string): DirectoryValidationResult {\n    const errors: MetadataError[] = [];\n\n    const filesForValidation = fs\n      .readdirSync(directoryPath)\n      .filter((file) => file.endsWith('.json') || file.endsWith('.txt'))\n      // Sorts the file names numerically ensuring that files are ordered naturally (e.g., '1', '2', '10' instead of '1', '10', '2').\n      .sort((a, b) => {\n        const numA = parseInt(a.match(/\\d+/)?.[0] ?? '0', 10);\n        const numB = parseInt(b.match(/\\d+/)?.[0] ?? '0', 10);\n        return numA - numB;\n      });\n    if (filesForValidation.length === 0) {\n      return {\n        isValid: false,\n        errors: [\n          {\n            general: [dictionary.validation.directoryIsEmpty],\n          },\n        ],\n      };\n    }\n\n    for (const file of filesForValidation) {\n      const filePath = path.join(directoryPath, file);\n      const validationResult = this.validateLocalFile(filePath);\n\n      if (!validationResult.isValid) {\n        errors.push({\n          fileName: file,\n          general: validationResult.errors,\n        });\n      }\n    }\n\n    return { isValid: errors.length === 0, errors };\n  }\n\n  static validateOnChainArrayOfObjects = (\n    metadataObjects: Awaited<MetadataFromMirrorNode>[]\n  ): { isValid: boolean; errors: Array<{ serialNumber: number; message: string[] }> } => {\n    const errors: Array<{ serialNumber: number; message: string[] }> = [];\n\n    metadataObjects.forEach((obj) => {\n      if (obj.error) {\n        errors.push({\n          serialNumber: obj.serialNumber,\n          message: [obj.error],\n        });\n      } else if (obj.metadata) {\n        try {\n          validateObjectWithSchema(Hip412MetadataSchema, obj.metadata, validationMetadataErrorOptions);\n        } catch (e) {\n          errors.push({\n            serialNumber: obj.serialNumber,\n            message: [errorToMessage(e)],\n          });\n        }\n      }\n    });\n\n    return { isValid: errors.length === 0, errors };\n  };\n\n  static async validateMetadataFromOnChainCollection(network: NetworkName, tokenId: string, ipfsGateway?: string, limit: number = 100) {\n    const metadataObjects = await getNftMetadataFromCollection(network, tokenId, limit, ipfsGateway);\n\n    return TokenMetadataValidator.validateOnChainArrayOfObjects(metadataObjects);\n  }\n\n  static async validateSingleOnChainNFTMetadata(network: NetworkName, tokenId: string, serialNumber: number, ipfsGateway?: string) {\n    const nft = await getSingleNFTDetails(network, tokenId, serialNumber);\n    const decodedNFTMetadataURL = uriDecoder(nft, ipfsGateway);\n\n    const metadataObject = await getMetadataObjectsForValidation(decodedNFTMetadataURL[0].metadata, decodedNFTMetadataURL[0].serialNumber);\n\n    if (!metadataObject.metadata) {\n      return {\n        isValid: false,\n        errors: {\n          general: [metadataObject.error],\n          missingAttributes: [],\n        },\n      };\n    }\n    return TokenMetadataValidator.validateSingleMetadataObject(metadataObject.metadata);\n  }\n}\n"],"mappings":"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","ignoreList":[]}