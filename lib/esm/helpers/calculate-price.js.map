{"version":3,"file":"calculate-price.js","names":["math","CONSTANT_TERM_WEIGHT","CONSTANTS_FOR_FORMULAE","FEE_SCHEDULE_MULTIPLIER","INITIAL_HEDERA_USAGE","NUM_NODES","PRICE_PRECISION","USD_TO_TINYCENTS","CREATE_TOKEN_NON_FUNGIBLE_UNIQUE","CREATE_TOKEN_NON_FUNGIBLE_UNIQUE_WITH_CUSTOM_FEES","FeeTool","model","constructor","apis","config","getCreateTokenCost","usage","price","Number","calculatePrice","getCreateTokenWithFeesCost","calculateUsage","customUsage","apiFormulae","updateUsageAutoRenewAccountSet","valuesForFormulaExecution","increaseInitialUsageWithCustomUsage","formulae","Object","entries","forEach","feeComponent","items","item","formula","validFeeComponent","usageItem","compiledFormula","parse","compile","undefined","evaluate","isAutoRenewAccountSet","sumHederaUsage","usage1","usage2","usageComponents","usageKeys","sum","component","subKey","value1","value2","actualUsage","usageSum","feeSchedules","normalizedPrice","toFixed"],"sources":["../../../src/helpers/calculate-price.ts"],"sourcesContent":["/*-\n *\n * Hedera NFT SDK\n *\n * Copyright (C) 2024 Hedera Hashgraph, LLC\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n *\n */\nimport {\n  FeeToolConfig,\n  Formulae,\n  HederaUsage,\n  TokenCreateUsage,\n  TokenCreateWithFeesUsage,\n  Usage,\n  UsageComponents,\n  UsageKeys,\n} from '../types/estimate-create-collection';\nimport * as math from 'mathjs';\nimport {\n  CONSTANT_TERM_WEIGHT,\n  CONSTANTS_FOR_FORMULAE,\n  FEE_SCHEDULE_MULTIPLIER,\n  INITIAL_HEDERA_USAGE,\n  NUM_NODES,\n  PRICE_PRECISION,\n  USD_TO_TINYCENTS,\n} from '../utils/constants/fee-tool';\nimport { CREATE_TOKEN_NON_FUNGIBLE_UNIQUE, CREATE_TOKEN_NON_FUNGIBLE_UNIQUE_WITH_CUSTOM_FEES } from '../utils/constants/fee-tool-config';\n\nexport class FeeTool {\n  private config: FeeToolConfig;\n  private static model = {\n    NUM_NODES,\n    CONSTANT_TERM_WEIGHT,\n    PRICE_PRECISION,\n    FEE_SCHEDULE_MULTIPLIER,\n    USD_TO_TINYCENTS,\n  };\n\n  private constructor(apis: FeeToolConfig) {\n    this.config = apis;\n  }\n\n  static getCreateTokenCost = (usage: TokenCreateUsage): number => {\n    const price = new FeeTool(CREATE_TOKEN_NON_FUNGIBLE_UNIQUE);\n    return Number(price.calculatePrice(usage).price);\n  };\n\n  static getCreateTokenWithFeesCost = (usage: TokenCreateWithFeesUsage): number => {\n    const price = new FeeTool(CREATE_TOKEN_NON_FUNGIBLE_UNIQUE_WITH_CUSTOM_FEES);\n    return Number(price.calculatePrice(usage).price);\n  };\n\n  private calculateUsage(customUsage: Usage, apiFormulae: Formulae): HederaUsage {\n    const usage: HederaUsage = INITIAL_HEDERA_USAGE;\n\n    this.updateUsageAutoRenewAccountSet(customUsage);\n\n    const valuesForFormulaExecution: typeof CONSTANTS_FOR_FORMULAE & Usage = {\n      ...customUsage,\n      ...CONSTANTS_FOR_FORMULAE,\n    };\n\n    return this.increaseInitialUsageWithCustomUsage(apiFormulae, usage, valuesForFormulaExecution);\n  }\n\n  private increaseInitialUsageWithCustomUsage(\n    formulae: Formulae,\n    usage: HederaUsage,\n    valuesForFormulaExecution: typeof CONSTANTS_FOR_FORMULAE & Usage\n  ): HederaUsage {\n    Object.entries(formulae).forEach(([feeComponent, items]) => {\n      Object.entries(items).forEach(([item, formula]) => {\n        const validFeeComponent = feeComponent as UsageComponents;\n        const usageItem = item as UsageKeys;\n        const compiledFormula = math.parse(formula).compile();\n\n        if (usage[validFeeComponent][usageItem] === undefined || usage[validFeeComponent][usageItem] === null) {\n          return;\n        }\n        usage[validFeeComponent][usageItem] = compiledFormula.evaluate(valuesForFormulaExecution);\n      });\n    });\n\n    return usage;\n  }\n\n  private updateUsageAutoRenewAccountSet(usage: Usage): void {\n    if ('isAutoRenewAccountSet' in usage && typeof usage.isAutoRenewAccountSet === 'boolean') {\n      usage.isAutoRenewAccountSet = usage.isAutoRenewAccountSet ? 1 : 0;\n    }\n  }\n\n  private sumHederaUsage(usage1: HederaUsage, usage2: HederaUsage): number {\n    const usageComponents = ['node', 'network', 'service'];\n    const usageKeys = ['constant', 'bpt', 'vpt', 'rbh', 'sbh', 'gas', 'bpr', 'sbpr', 'min', 'max'];\n    let sum = 0;\n\n    for (const component of usageComponents as UsageComponents[]) {\n      for (const subKey of usageKeys as UsageKeys[]) {\n        const value1 = usage1[component][subKey];\n        const value2 = usage2[component][subKey];\n        if (value1 && value2) {\n          sum = sum + value1 * value2;\n        }\n      }\n    }\n\n    return sum;\n  }\n\n  private calculatePrice(customUsage: Usage): {\n    usage: HederaUsage;\n    price: string;\n  } {\n    const actualUsage = this.calculateUsage(customUsage, this.config.formulae);\n    const usageSum = this.sumHederaUsage(this.config.feeSchedules, actualUsage);\n    const normalizedPrice = math.evaluate(`${usageSum} / (${FeeTool.model.FEE_SCHEDULE_MULTIPLIER} * ${FeeTool.model.USD_TO_TINYCENTS})`);\n\n    return {\n      usage: actualUsage,\n      price: normalizedPrice.toFixed(FeeTool.model.PRICE_PRECISION),\n    };\n  }\n}\n"],"mappings":"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","ignoreList":[]}